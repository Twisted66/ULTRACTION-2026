---
// Header.astro - ULTRACTION Website Header (Nova Construct Design Pattern)
const pathname = Astro.url.pathname.replace(/\/$/, "");
const isActive = (href: string) => {
  const normalizedHref = href.replace(/\/$/, "");
  if (normalizedHref === "") return pathname === "";
  return pathname === normalizedHref;
};
---

<header id="site-header" class="w-full border-b border-black dark:border-black fixed top-0 left-0 right-0 z-50 bg-background">
  <div class="flex flex-wrap md:flex-nowrap">
    <!-- Logo - Left Side -->
    <div class="w-full md:w-96 px-6 py-3 md:px-12 md:py-5 flex items-center justify-between">
      <a href="/" class="font-bold text-lg tracking-wide uppercase flex items-center gap-3 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary">
        <img src="/logo/UGC-HEADER.png" alt="ULTRACTION" class="h-12 md:h-16 w-auto" />
      </a>
      <button
        id="mobile-menu-toggle"
        class="md:hidden text-foreground p-2 min-h-[44px] min-w-[44px] focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary"
        aria-label="Open navigation menu"
        aria-controls="mobile-nav"
        aria-expanded="false"
      >
        <svg id="hamburger-icon" class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path d="M4 6h16M4 12h16M4 18h16" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
        </svg>
        <svg id="close-icon" class="h-6 w-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
        </svg>
      </button>
    </div>

    <!-- Spacer to push nav to the right -->
    <div class="hidden md:flex flex-1"></div>

    <!-- Right Navigation - All links -->
    <div class="hidden md:flex">
      <a href="/" aria-current={isActive('/') ? 'page' : undefined} class="px-8 lg:px-12 py-6 text-black hover:bg-primary/10 transition-colors flex items-center justify-between gap-4 group focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary">
        <span class="font-bold tracking-tight text-sm lg:text-base">HOME</span>
        <span class={`w-1.5 h-1.5 rounded-full bg-black group-hover:opacity-100 transition-opacity ${isActive('/') ? 'opacity-100' : 'opacity-0'}`}></span>
      </a>
      <a href="/about" aria-current={isActive('/about') ? 'page' : undefined} class="px-8 lg:px-12 py-6 text-black hover:bg-primary/10 transition-colors flex items-center justify-between gap-4 group focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary">
        <span class="font-bold tracking-tight text-sm lg:text-base">ABOUT US</span>
        <span class={`w-1.5 h-1.5 rounded-full bg-black group-hover:opacity-100 transition-opacity ${isActive('/about') ? 'opacity-100' : 'opacity-0'}`}></span>
      </a>
      <a href="/services" aria-current={isActive('/services') ? 'page' : undefined} class="px-8 lg:px-12 py-6 text-black hover:bg-primary/10 transition-colors flex items-center justify-between gap-4 group focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary">
        <span class="font-bold tracking-tight text-sm lg:text-base">SERVICES</span>
        <span class={`w-1.5 h-1.5 rounded-full bg-black group-hover:opacity-100 transition-opacity ${isActive('/services') ? 'opacity-100' : 'opacity-0'}`}></span>
      </a>
      <a href="/projects" aria-current={isActive('/projects') ? 'page' : undefined} class="px-8 lg:px-12 py-6 text-black hover:bg-primary/10 transition-colors flex items-center justify-between gap-4 group focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary">
        <span class="font-bold tracking-tight text-sm lg:text-base">PROJECTS</span>
        <span class={`w-1.5 h-1.5 rounded-full bg-black group-hover:opacity-100 transition-opacity ${isActive('/projects') ? 'opacity-100' : 'opacity-0'}`}></span>
      </a>
      <a href="/contact" aria-current={isActive('/contact') ? 'page' : undefined} class="px-8 lg:px-12 py-6 text-black hover:bg-primary/10 transition-colors flex items-center justify-between gap-4 group focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary">
        <span class="font-bold tracking-tight text-sm lg:text-base">CONTACT</span>
        <span class={`w-1.5 h-1.5 rounded-full bg-black group-hover:opacity-100 transition-opacity ${isActive('/contact') ? 'opacity-100' : 'opacity-0'}`}></span>
      </a>
    </div>
  </div>

  <!-- Mobile Navigation Menu -->
  <nav id="mobile-nav" class="hidden md:hidden fixed inset-0 z-40 bg-background border-t border-black dark:border-black top-[72px]" role="dialog" aria-modal="true" aria-hidden="true" tabindex="-1">
    <div class="flex flex-col h-full overflow-y-auto max-h-[calc(100vh-72px)]">
      <a href="/" aria-current={isActive('/') ? 'page' : undefined} class={`flex items-center justify-between px-6 min-h-[44px] transition-colors font-medium border-b border-black/10 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary ${isActive('/') ? 'bg-primary/5 text-accent' : 'text-foreground hover:bg-primary/10'}`}>
        <span>HOME</span>
        <svg class={`w-4 h-4 ${isActive('/') ? 'text-accent' : 'text-foreground'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"></path></svg>
      </a>
      <a href="/about" aria-current={isActive('/about') ? 'page' : undefined} class={`flex items-center justify-between px-6 min-h-[44px] transition-colors font-medium border-b border-black/10 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary ${isActive('/about') ? 'bg-primary/5 text-accent' : 'text-foreground hover:bg-primary/10'}`}>
        <span>ABOUT US</span>
        <svg class={`w-4 h-4 ${isActive('/about') ? 'text-accent' : 'text-foreground'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"></path></svg>
      </a>
      <a href="/services" aria-current={isActive('/services') ? 'page' : undefined} class={`flex items-center justify-between px-6 min-h-[44px] transition-colors font-medium border-b border-black/10 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary ${isActive('/services') ? 'bg-primary/5 text-accent' : 'text-foreground hover:bg-primary/10'}`}>
        <span>SERVICES</span>
        <svg class={`w-4 h-4 ${isActive('/services') ? 'text-accent' : 'text-foreground'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"></path></svg>
      </a>
      <a href="/projects" aria-current={isActive('/projects') ? 'page' : undefined} class={`flex items-center justify-between px-6 min-h-[44px] transition-colors font-medium border-b border-black/10 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary ${isActive('/projects') ? 'bg-primary/5 text-accent' : 'text-foreground hover:bg-primary/10'}`}>
        <span>PROJECTS</span>
        <svg class={`w-4 h-4 ${isActive('/projects') ? 'text-accent' : 'text-foreground'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"></path></svg>
      </a>
      <a href="/contact" aria-current={isActive('/contact') ? 'page' : undefined} class={`flex items-center justify-between px-6 min-h-[44px] transition-colors font-medium focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary ${isActive('/contact') ? 'bg-primary/5 text-accent' : 'text-foreground hover:bg-primary/10'}`}>
        <span>CONTACT</span>
        <svg class={`w-4 h-4 ${isActive('/contact') ? 'text-accent' : 'text-foreground'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"></path></svg>
      </a>
    </div>
  </nav>
</header>

<script>
  // Mobile menu toggle functionality
  const toggle = document.getElementById('mobile-menu-toggle');
  const mobileNav = document.getElementById('mobile-nav');
  const siteHeader = document.getElementById('site-header');
  let lastFocusedElement: HTMLElement | null = null;

  function setMobileMenuState(isOpen: boolean) {
    if (!toggle || !mobileNav) return;

    const hamburgerIcon = document.getElementById('hamburger-icon');
    const closeIcon = document.getElementById('close-icon');

    toggle.setAttribute('aria-expanded', String(isOpen));
    toggle.setAttribute('aria-label', isOpen ? 'Close navigation menu' : 'Open navigation menu');
    mobileNav.classList.toggle('hidden', !isOpen);
    mobileNav.setAttribute('aria-hidden', String(!isOpen));

    if (hamburgerIcon && closeIcon) {
      hamburgerIcon.classList.toggle('hidden', isOpen);
      closeIcon.classList.toggle('hidden', !isOpen);
    }

    setBackgroundInert(isOpen);

    // Prevent body scroll when menu is open
    document.body.style.overflow = isOpen ? 'hidden' : 'auto';

    if (isOpen) {
      const focusTargets = getFocusableElements(mobileNav);
      window.requestAnimationFrame(() => {
        const firstTarget = focusTargets[0];
        if (firstTarget) {
          firstTarget.focus();
        }
      });
    } else {
      const focusRestoreTarget =
        lastFocusedElement && document.contains(lastFocusedElement) ? lastFocusedElement : toggle;
      window.requestAnimationFrame(() => {
        if (focusRestoreTarget instanceof HTMLElement) {
          focusRestoreTarget.focus();
        }
      });
    }
  }

  toggle?.addEventListener('click', () => {
    if (document.activeElement instanceof HTMLElement) {
      lastFocusedElement = document.activeElement;
    }
    const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
    setMobileMenuState(!isExpanded);
  });

  // Close mobile nav when clicking a link
  const mobileLinks = mobileNav?.querySelectorAll('a');
  mobileLinks?.forEach((link) => {
    link.addEventListener('click', () => {
      setMobileMenuState(false);
    });
  });

  // Close mobile nav when clicking outside or pressing Escape
  document.addEventListener('click', (e) => {
    if (toggle && mobileNav && e.target instanceof HTMLElement && !toggle.contains(e.target) && !mobileNav.contains(e.target)) {
      closeMobileMenu();
    }
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeMobileMenu();
      return;
    }

    if (e.key === 'Tab' && toggle?.getAttribute('aria-expanded') === 'true' && mobileNav instanceof HTMLElement) {
      trapMobileMenuFocus(e);
    }
  });

  window.addEventListener('resize', () => {
    if (window.innerWidth >= 768) {
      closeMobileMenu();
    }
  });

  function getFocusableElements(container: HTMLElement) {
    const selectors = [
      'a[href]',
      'button:not([disabled])',
      'textarea:not([disabled])',
      'input:not([disabled])',
      'select:not([disabled])',
      '[tabindex]:not([tabindex="-1"])'
    ];

    return Array.from(container.querySelectorAll<HTMLElement>(selectors.join(','))).filter((el) => {
      return !el.hasAttribute('disabled') && el.getAttribute('aria-hidden') !== 'true';
    });
  }

  function trapMobileMenuFocus(event: KeyboardEvent) {
    if (!(mobileNav instanceof HTMLElement)) return;
    const focusable = getFocusableElements(mobileNav);
    if (focusable.length === 0) return;

    const first = focusable[0];
    const last = focusable[focusable.length - 1];
    const activeElement = document.activeElement;

    if (event.shiftKey && activeElement === first) {
      event.preventDefault();
      last.focus();
    } else if (!event.shiftKey && activeElement === last) {
      event.preventDefault();
      first.focus();
    }
  }

  function setBackgroundInert(isOpen: boolean) {
    if (!siteHeader) return;
    const bodyChildren = Array.from(document.body.children);

    bodyChildren.forEach((element) => {
      if (element === siteHeader) return;

      if (isOpen) {
        element.setAttribute('inert', '');
        element.setAttribute('aria-hidden', 'true');
      } else {
        element.removeAttribute('inert');
        element.removeAttribute('aria-hidden');
      }
    });
  }

  function closeMobileMenu() {
    setMobileMenuState(false);
  }
</script>
