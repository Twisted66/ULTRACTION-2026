---
// Careers page - ULTRACTION General Contracting LLC
// Upgraded to match the premium industrial design system

import Layout from '../layouts/Layout.astro';
import MagneticButton from '../components/ui/MagneticButton.astro';
import Globe3DDemo from '../components/3d-globe-demo';

// SEO Metadata
const title = "Careers - ULTRACTION GENERAL CONTRACTING LLC";
const description = "Join the ULTRACTION team. We are looking for driven engineers, site professionals, and project leaders to build high-impact infrastructure in the UAE and KSA.";
const jobsApiBaseUrl = import.meta.env.PUBLIC_JOBS_API_BASE_URL?.trim() ?? '';
---

<Layout
  title={title}
  description={description}
  image="/logo/UGC-HEADER.png"
>
  <div class="grid grid-cols-1 lg:grid-cols-2 min-h-[calc(100vh-104px)] border-t border-border">
      
      <!-- Left: Content (Brand Beige) -->
      <div class="bg-surface text-primary p-8 lg:p-20 flex flex-col justify-center order-2 lg:order-1 relative z-10 border-r border-primary/20 overflow-hidden">
        {/* Grid pattern overlay */}
        <div class="absolute inset-0 pointer-events-none opacity-[0.03]" style={{
          backgroundImage: `
            linear-gradient(to right, currentColor 1px, transparent 1px),
            linear-gradient(to bottom, currentColor 1px, transparent 1px)
          `,
          backgroundSize: '60px 60px'
        }}></div>

        {/* Animated gradient accent */}
        <div class="absolute top-0 left-1/4 w-96 h-96 bg-accent/5 rounded-full blur-3xl pointer-events-none animate-pulse-slow"></div>

        <div class="max-w-xl mx-auto w-full relative z-10">
          <span class="text-xs font-bold uppercase tracking-widest opacity-80 mb-4 block">Careers</span>
          <h1 class="text-5xl lg:text-7xl font-bold uppercase leading-none mb-12 font-heading">
            Join Our<br/><span class="text-accent italic">Expert Team</span>.
          </h1>
          
          <div class="space-y-6 text-lg opacity-80 leading-relaxed font-body">
            <p>
              ULTRACTION is always looking for driven engineers, site professionals, and project leaders who want to build high-impact infrastructure.
            </p>
            <p>
              If you are ready to contribute to complex construction and contracting projects across the UAE and KSA, we want to hear from you.
            </p>
          </div>

          <div class="mt-12 p-8 bg-background/30 backdrop-blur-sm border border-primary/10 rounded-none relative overflow-hidden group">
            <div class="absolute top-0 left-0 w-1 h-full bg-accent translate-y-full group-hover:translate-y-0 transition-transform duration-500"></div>
            <p class="text-sm uppercase tracking-widest font-bold mb-6 flex items-center gap-3">
              <span class="w-8 h-[1px] bg-accent"></span>
              How to Apply
            </p>
            <p class="text-sm opacity-70 mb-8 leading-relaxed">
              Include your target role, years of experience, availability, and a link to your CV or portfolio in your message.
            </p>
            
            <MagneticButton
              href="/contact?subject=careers"
              variant="primary"
              magnetic={false}
              ripple={false}
              size="lg"
              class="w-full sm:w-auto bg-[#800000] text-white hover:bg-[#800000] focus-visible:outline-[#800000]"
            >
              <span class="flex items-center gap-4">
                Apply via Contact Form
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
              </span>
            </MagneticButton>
          </div>

          <section class="mt-10 border border-primary/15 bg-background/30 backdrop-blur-sm p-7">
            <div class="flex items-center justify-between gap-3 mb-6">
              <h2 class="text-sm uppercase tracking-[0.2em] font-bold">Open Roles</h2>
              <span id="jobs-count" class="text-[10px] uppercase tracking-widest opacity-60">Loading...</span>
            </div>

            <p id="jobs-status" class="text-sm opacity-70 leading-relaxed">
              Fetching current opportunities...
            </p>

            <ul id="jobs-list" class="space-y-4 hidden" aria-live="polite"></ul>
          </section>
        </div>
      </div>

      <!-- Right: Visual (Default Background) -->
      <div class="bg-background relative min-h-[50vh] lg:min-h-screen order-1 lg:order-2 overflow-hidden flex items-center justify-center">
          <div class="absolute inset-0 z-0 flex items-center justify-center">
               <Globe3DDemo client:only="react" className="h-[700px] w-[125%] -translate-y-14" />
          </div>

          {/* Grid pattern overlay */}
          <div class="absolute inset-0 pointer-events-none opacity-[0.03]" style={{
            backgroundImage: `
              linear-gradient(to right, currentColor 1px, transparent 1px),
              linear-gradient(to bottom, currentColor 1px, transparent 1px)
            `,
            backgroundSize: '60px 60px'
          }}></div>

          {/* Animated gradient accent */}
          <div class="absolute top-0 right-1/4 w-96 h-96 bg-accent/5 rounded-full blur-3xl pointer-events-none animate-pulse-slow"></div>

          <!-- Feature Tag -->
          <div class="absolute top-12 right-12 z-20 hidden lg:block">
            <div class="bg-surface/90 backdrop-blur-md px-6 py-4 border border-primary/10 flex flex-col items-end">
              <span class="text-[10px] uppercase tracking-[0.3em] text-accent font-bold mb-1">Global Reach</span>
              <span class="text-xs font-bold opacity-60">UAE & KSA Operations</span>
            </div>
          </div>

          <!-- Why Join Section (Small overlay) -->
          <div class="absolute bottom-12 right-12 z-20 hidden xl:block max-w-xs">
            <div class="bg-white backdrop-blur-xl border border-primary/20 overflow-hidden">
              <div class="bg-[#800000] px-8 py-4">
                <h3 class="text-sm font-bold uppercase tracking-[0.2em] text-white">Why ULTRACTION?</h3>
              </div>
              <div class="p-8">
                <ul class="space-y-3 text-xs uppercase tracking-widest font-bold opacity-70">
                  <li class="flex items-center gap-3"><span class="w-1.5 h-1.5 bg-accent rounded-full"></span> Iconic Projects</li>
                  <li class="flex items-center gap-3"><span class="w-1.5 h-1.5 bg-accent rounded-full"></span> Expert Leadership</li>
                  <li class="flex items-center gap-3"><span class="w-1.5 h-1.5 bg-accent rounded-full"></span> Innovation Driven</li>
                </ul>
              </div>
            </div>
          </div>
      </div>
  </div>
</Layout>

<style>
  /* Slow pulse for accent blob */
  @keyframes pulse-slow {
    0%, 100% {
      opacity: 0.3;
      transform: scale(1);
    }
    50% {
      opacity: 0.5;
      transform: scale(1.3);
    }
  }

  .animate-pulse-slow {
    animation: pulse-slow 12s ease-in-out infinite;
  }
</style>

<script is:inline define:vars={{ jobsApiBaseUrl }}>
  const statusElement = document.getElementById('jobs-status');
  const countElement = document.getElementById('jobs-count');
  const listElement = document.getElementById('jobs-list');

  function formatEmploymentType(value) {
    if (!value || typeof value !== 'string') return 'Role';
    return value
      .split('-')
      .map((part) => part.charAt(0).toUpperCase() + part.slice(1))
      .join(' ');
  }

  function renderJobs(jobs) {
    if (!listElement || !statusElement || !countElement) return;
    if (!Array.isArray(jobs) || jobs.length === 0) {
      countElement.textContent = '0 Open Roles';
      statusElement.textContent =
        'No openings are live at the moment. You can still submit your CV through the contact form.';
      return;
    }

    countElement.textContent = `${jobs.length} Open Role${jobs.length > 1 ? 's' : ''}`;
    statusElement.classList.add('hidden');
    listElement.classList.remove('hidden');

    listElement.innerHTML = jobs
      .map((job) => {
        const title = typeof job.title === 'string' ? job.title : 'Untitled Role';
        const location = typeof job.location === 'string' ? job.location : 'UAE';
        const department = typeof job.department === 'string' ? job.department : '';
        const employmentType = formatEmploymentType(job.employmentType);
        const summary =
          typeof job.summary === 'string'
            ? job.summary
            : typeof job.description === 'string'
              ? job.description
              : '';
        const safeTitle = title.replace(/[<>]/g, '');
        const safeLocation = location.replace(/[<>]/g, '');
        const safeDepartment = department.replace(/[<>]/g, '');
        const safeSummary = summary.replace(/[<>]/g, '');

        return `
          <li class="border border-primary/15 bg-surface/70 px-5 py-5 transition-colors duration-300 hover:border-accent/60">
            <div class="flex flex-wrap items-start justify-between gap-3">
              <div class="space-y-2">
                <h3 class="text-xl font-bold uppercase leading-tight font-heading">${safeTitle}</h3>
                <p class="text-xs uppercase tracking-widest opacity-70">${safeLocation}${safeDepartment ? ` • ${safeDepartment}` : ''}</p>
              </div>
              <span class="text-[10px] uppercase tracking-[0.2em] font-bold text-accent">${employmentType}</span>
            </div>
            ${
              safeSummary
                ? `<p class="mt-4 text-sm opacity-75 leading-relaxed">${safeSummary}</p>`
                : ''
            }
            <a
              href="/contact?subject=careers"
              class="inline-flex items-center gap-2 mt-5 text-xs uppercase tracking-[0.2em] font-bold text-accent hover:text-primary transition-colors duration-200"
            >
              Apply For This Role
              <span aria-hidden="true">→</span>
            </a>
          </li>
        `;
      })
      .join('');
  }

  async function loadJobs() {
    if (!statusElement || !countElement) return;

    const base = typeof jobsApiBaseUrl === 'string' ? jobsApiBaseUrl.trim().replace(/\/$/, '') : '';
    const endpoint = base ? `${base}/api/jobs` : '/api/jobs';

    try {
      const response = await fetch(endpoint, {
        method: 'GET',
        headers: { Accept: 'application/json' },
        cache: 'no-store',
      });

      if (!response.ok) {
        throw new Error(`jobs_fetch_failed_${response.status}`);
      }

      const payload = await response.json();
      const jobs = payload?.data?.jobs ?? payload?.jobs ?? [];
      renderJobs(jobs);
    } catch (error) {
      console.error('Unable to load jobs feed on /careers:', error);
      countElement.textContent = 'Unavailable';
      statusElement.textContent =
        'Live roles are temporarily unavailable. Please apply through the contact form and we will review your profile.';
    }
  }

  loadJobs();
</script>
