---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import LogoLoop from '../../components/common/LogoLoop.astro';
import MagicBento, { type MagicBentoItem } from '../../components/projects/MagicBento';

// Pre-render this page as static HTML at build time
export const prerender = true;

export async function getStaticPaths() {
  const projects = await getCollection('projects');
  return projects.map(project => ({
    params: { slug: project.slug },
    props: { project },
  }));
}

const slug = Astro.params.slug;
const projectFromProps = Astro.props.project;
const projectFromSlug = slug
  ? (await getCollection('projects')).find((entry) => entry.slug === slug)
  : undefined;
const project = projectFromProps ?? projectFromSlug;

if (!project) {
  return Astro.redirect('/projects');
}

const { Content } = await project.render();

// Format dates
const formatDate = (date: string | Date) => {
  return new Date(date).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
  });
};

const rawMagicBentoItems: (MagicBentoItem | null)[] = [
  project.data.client
    ? {
        id: 'client',
        label: 'Client',
        value: project.data.client,
        meta: project.data.category,
        emphasis: 'primary',
        colSpan: 2,
      }
    : null,
  project.data.location
    ? {
        id: 'location',
        label: 'Location',
        value: project.data.location,
      }
    : null,
  project.data.completed
    ? {
        id: 'completion',
        label: 'Completion',
        value: formatDate(project.data.completed),
      }
    : null,
  project.data.duration
    ? {
        id: 'duration',
        label: 'Duration',
        value: project.data.duration,
      }
    : null,
  project.data.status
    ? {
        id: 'status',
        label: 'Status',
        value: project.data.status,
      }
    : null,
  project.data.size
    ? {
        id: 'scale',
        label: 'Scale',
        value: project.data.size,
      }
    : null,
];

const magicBentoItems: MagicBentoItem[] = rawMagicBentoItems.filter(
  (item): item is MagicBentoItem => item !== null
);

// Colors based on category (optional refinement)
// For now using standard brand colors
---

<Layout
  title={`${project.data.title} - ULTRACTION Projects`}
  description={`Case study: ${project.data.title} - ${project.data.category} project in ${project.data.location}.`}
  image={project.data.images?.[0] || '/logo/UGC-HEADER.png'}
>
  <!-- Hero Section with Parallax -->
  <section class="relative h-[60vh] md:h-[80vh] min-h-[400px] md:min-h-[600px] overflow-hidden">
    <div class="absolute inset-0">
      {project.data.images && project.data.images.length > 0 ? (
        <img
          src={project.data.images[0]}
          alt={project.data.title}
          class="w-full h-full object-cover"
          style="transform: scale(1.1);" 
        />
      ) : (
        <div class="w-full h-full bg-primary/10"></div>
      )}
      <div class="absolute inset-0 bg-gradient-to-t from-black via-black/40 to-black/30"></div>
    </div>

    <div class="absolute inset-0 flex flex-col justify-end p-6 md:p-16 lg:p-24 pb-12 md:pb-24">
      <div class="max-w-4xl animate-slide-up">
        <div class="flex items-center gap-3 mb-4 md:mb-6">
          <span class="px-2 md:px-3 py-1 bg-accent text-white text-[10px] md:text-xs uppercase tracking-widest font-semibold">{project.data.category}</span>
          {project.data.featured && (
            <span class="px-2 md:px-3 py-1 border border-white/30 text-white text-[10px] md:text-xs uppercase tracking-widest">Featured Project</span>
          )}
        </div>
        
        <h1 class="text-3xl md:text-6xl lg:text-7xl font-bold text-white mb-4 md:mb-6 uppercase leading-[1.1] font-heading">
          {project.data.title}
        </h1>
        
        <p class="text-xl md:text-2xl text-white/80 font-light max-w-2xl">
          {project.data.location}
        </p>
      </div>
    </div>
  </section>

  <!-- Project Details Grid -->
  <section class="border-b border-primary/20 dark:border-white/20 bg-surface">
    <div class="grid grid-cols-2 md:grid-cols-4 md:divide-x divide-primary/20 dark:divide-white/20">
      <div class="p-6 md:p-12 border-b md:border-b-0 border-r border-primary/20 md:border-r-0">
        <span class="block text-[10px] md:text-xs uppercase tracking-widest opacity-60 mb-2">Client</span>
        <span class="block text-base md:text-xl font-bold">{project.data.client || 'Confidential'}</span>
      </div>
      <div class="p-6 md:p-12 border-b md:border-b-0">
        <span class="block text-[10px] md:text-xs uppercase tracking-widest opacity-60 mb-2">Completion</span>
        <span class="block text-base md:text-xl font-bold">{formatDate(project.data.completed)}</span>
      </div>
      <div class="p-6 md:p-12 border-r border-primary/20 md:border-r-0">
        <span class="block text-[10px] md:text-xs uppercase tracking-widest opacity-60 mb-2">Duration</span>
        <span class="block text-base md:text-xl font-bold">{project.data.duration || 'N/A'}</span>
      </div>
      <div class="p-6 md:p-12">
        <span class="block text-[10px] md:text-xs uppercase tracking-widest opacity-60 mb-2">Status</span>
        <span class="block text-base md:text-xl font-bold">{project.data.status || 'Completed'}</span>
      </div>
    </div>
  </section>

  {/* Magic Bento Project Overview */}
  {magicBentoItems.length > 0 && (
    <section class="py-16 px-8 md:px-16 lg:px-24 bg-background border-b border-primary/20 dark:border-white/20">
      <div class="max-w-7xl mx-auto">
        <h2 class="text-2xl md:text-3xl font-heading font-semibold uppercase mb-8 tracking-[0.25em] text-primary">
          Project Overview
        </h2>
        <MagicBento client:idle items={magicBentoItems} />
      </div>
    </section>
  )}

  <!-- Main Content & Sidebar -->
  <section class="py-20 px-8 md:px-16 lg:px-24 border-b border-primary/20 dark:border-white/20">
    <div class="flex flex-col lg:flex-row gap-16 lg:gap-24 max-w-7xl mx-auto">
      <!-- Content Area -->
      <div class="w-full lg:w-2/3">
        <div class="prose prose-lg dark:prose-invert max-w-none prose-headings:font-heading prose-headings:uppercase prose-p:font-light prose-li:font-light">
          <Content />
        </div>
      </div>

      <!-- Sticky Sidebar -->
      <div class="w-full lg:w-1/3">
        <div class="sticky top-24 space-y-12">
          {project.data.size && (
            <div class="pb-8 border-b border-primary/20 dark:border-white/20">
              <span class="block text-5xl md:text-6xl font-bold text-accent mb-2">{project.data.size}</span>
              <span class="text-sm uppercase tracking-widest opacity-60">Project Scale</span>
            </div>
          )}
          
          <div>
            <h3 class="text-xl font-bold uppercase mb-6 font-heading">Share Project</h3>
            <div class="flex gap-4">
              <button class="w-10 h-10 rounded-full border border-primary/20 dark:border-white/20 flex items-center justify-center hover:bg-primary hover:text-white dark:hover:bg-white dark:hover:text-primary transition-colors">
                <span class="sr-only">LinkedIn</span>
                <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
              </button>
              <button class="w-10 h-10 rounded-full border border-primary/20 dark:border-white/20 flex items-center justify-center hover:bg-primary hover:text-white dark:hover:bg-white dark:hover:text-primary transition-colors">
                <span class="sr-only">Twitter</span>
                <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24"><path d="M24 4.557c-.883.392-1.832.656-2.828.775 1.017-.609 1.798-1.574 2.165-2.724-.951.564-2.005.974-3.127 1.195-.897-.957-2.178-1.555-3.594-1.555-3.179 0-5.515 2.966-4.797 6.045-4.091-.205-7.719-2.165-10.148-5.144-1.29 2.213-.669 5.108 1.523 6.574-.806-.026-1.566-.247-2.229-.616-.054 2.281 1.581 4.415 3.949 4.89-.693.188-1.452.232-2.224.084.626 1.956 2.444 3.379 4.6 3.419-2.07 1.623-4.678 2.348-7.29 2.04 2.179 1.397 4.768 2.212 7.548 2.212 9.142 0 14.307-7.721 13.995-14.646.962-.695 1.797-1.562 2.457-2.549z"/></svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Project Gallery -->
  {project.data.images && project.data.images.length > 1 && (
    <section class="py-20 px-4 md:px-8 border-b border-primary/20 dark:border-white/20 bg-surface">
      <div class="max-w-[1800px] mx-auto">
        <div class="text-center mb-16">
          <h2 class="text-3xl font-bold uppercase mb-4 font-heading">Project Gallery</h2>
          <div class="w-20 h-1 bg-accent mx-auto"></div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {project.data.images.slice(1).map((image, index) => (
            <div class="group relative aspect-[4/3] overflow-hidden cursor-pointer">
              <img 
                src={image} 
                alt={`${project.data.title} view ${index + 2}`} 
                class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
              />
              <div class="absolute inset-0 bg-primary/20 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
            </div>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- Next/Prev Navigation (Simplified to just Next for now) -->
  <section class="py-24 bg-primary text-white text-center">
    <div class="container mx-auto px-8">
      <h3 class="text-sm uppercase tracking-[0.3em] opacity-60 mb-6">Interested in working with us?</h3>
      <h2 class="text-4xl md:text-6xl font-bold uppercase mb-12 max-w-4xl mx-auto font-heading leading-tight">
        Let's Build Your<br/>Vision Together
      </h2>
      <a href="/contact" class="inline-block border border-white/30 hover:bg-white hover:text-primary text-white py-5 px-12 uppercase tracking-widest text-sm transition-all duration-300">
        Get in Touch
      </a>
    </div>
  </section>

  <LogoLoop />
</Layout>

<style>
  .animate-slide-up {
    animation: slideUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    opacity: 0;
    transform: translateY(40px);
  }

  @keyframes slideUp {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
